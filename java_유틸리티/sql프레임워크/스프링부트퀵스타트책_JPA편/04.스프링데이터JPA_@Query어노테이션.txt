@Query 어노테이션


스프링 데이터 JPA의 @Query 어노테이션은 JpaRepository 메서드에 JPQL(Java Persistence Query Language)이나 
네이티브 SQL을 직접 정의하여 복잡한 쿼리나 특정 조건을 처리할 수 있게 해주는 기능입니다.
	
간단한 CRUD 외에 조인, 서브쿼리, 복잡한 WHERE 절이 필요한 경우.
특정 시점의 데이터를 가져오거나 집계(COUNT, SUM 등) 함수를 사용해야 할 때.
쿼리 메서드만으로는 구현하기 어려운 동적 쿼리를 작성할 때 QueryDsl과 함께 사용되기도 합니다.


아래 사용 테스트 분석
	위치기반 파라미터 바인딩 
	이름기반 파라미터 바인딩
	네이티브 쿼리 사용
	Pageable 인터페이스를 사용한 페이지 정렬처리
	
------------------- application.properties

# DataSource Setting
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.username=sa
spring.datasource.password=

# JPA Setting
spring.jpa.hibernate.ddl-auto=update #create
spring.jpa.generate-ddl=false
spring.jpa.show-sql=true
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
spring.jpa.properties.hibernate.format_sql=true

# Logging Setting
logging.level.org.hibernate=info

------------------- Board.java

package com.solgae.domain;

import java.time.LocalDateTime;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;

@Getter
@Setter
@ToString
@Entity
public class Board {

	@Id
	@GeneratedValue
	private Long seq;
	private String title;
	private String writer;
	private String content;
	private LocalDateTime createDate;
	private Long cnt;
}

------------------- 리포지터리.java

package com.solgae.persistence;

import java.util.List;

import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.CrudRepository;
import org.springframework.data.repository.query.Param;

import com.solgae.domain.Board;

/**
 * Query 어노테이션 사용 리포지토리
 */
public interface AnnotationRepositary extends CrudRepository<Board, Long>{
		
	//위치기반 Query 어노테이션
	@Query("select b from Board b where b.title like %?1% order by b.seq DESC")
	List<Board> queryAnnotation1(String searchKeyword);
	
	//이름기반 Query 어노테이션
	@Query("select b from Board b where b.title like %:searchKeyword% order by b.seq DESC")
	List<Board> queryAnnotation2(@Param("searchKeyword") String searchKeyword);
	
	//엔티티로 전체 검색이 아닌, 특정 변수만 조회하고 싶으면 Object[]를 사용해야한다.
	//위치기반 + 이름기반 섞어서 쓰기 (섞어도 동작은 되지만 그렇게 사용하지는 말자)
	@Query("select b.seq, b.title from Board b where b.title like %?1% order by b.seq DESC")
	List<Object[]> queryAnnotation3(@Param("searchKeyword") String searchKeyword);
	
	//네이티브 쿼리 사용
	@Query(value="select seq, title  from board where title like '%' || ?1 || '%' order by seq DESC", nativeQuery = true)
	List<Object[]> queryAnnotation4(@Param("searchKeyword") String searchKeyword);
	
	//Pageable 인터페이스로 페이징 처리하기
	@Query("select b from Board b order by b.seq DESC")
	List<Board> queryAnnotation5(Pageable paging);
	
}

------------------- 테스트하기

package com.solgae.repositary;

import java.util.Arrays;
import java.util.List;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;

import com.solgae.domain.Board;
import com.solgae.persistence.AnnotationRepositary;

@SpringBootTest
public class QueryAnnotationTest {

	@Autowired
	AnnotationRepositary repositary;
	
	//위치기반 파라미터 
	@Test
	public void test1() { 
		
		List<Board> resutList = repositary.queryAnnotation1("테스트 제목10");
		
		for(Board board : resutList) {
			System.out.println(board.toString());
		}
	}
	
	//이름기반 파라미터
	@Test
	public void test2() {
		List<Board> resultList = repositary.queryAnnotation2("테스트 제목20");
		for(Board board : resultList) {
			System.out.println(board.toString());
		}
	}
	
	// 엔티티 일부(컬럼)만 검색 조회할 때는 Object[]로 받아야한다.
	@Test
	public void test3() {
		List<Object[]> resultList = repositary.queryAnnotation3("테스트 제목20");
		for(Object[] board : resultList) {
			System.out.println(Arrays.toString(board));
			System.out.println(board[0]+"/"+board[1]); // seq/테스트제목 20..
		}
	}
	
	
	// 네이티브 쿼리 사용하기
	@Test
	public void test4() {
		List<Object[]> resultList = repositary.queryAnnotation4("테스트 제목20");
		for(Object[] board : resultList) {
			System.out.println(Arrays.toString(board));
			System.out.println(board[0] + "/" + board[1]); // seq/테스트제목 20..
		}
	}
	
	// Pageable 인터페이스를 활용한 페이지 처리
	@Test
	public void test5() {
		Pageable paging = PageRequest.of(0, 5 , Sort.Direction.DESC , "seq");
		List<Board> resultList = repositary.queryAnnotation5(paging);
		for(Board board : resultList) {
			System.out.println(board.toString());
		}
	}
}

